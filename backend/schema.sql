-- Oracle Database Schema for DocuDigitize Pro

-- Drop tables if they exist (to allow clean re-runs)
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE PATIENT_DOC_INFO';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE PATIENT_INFO';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

-- 1a. References Table (New)
CREATE TABLE DOC_REFS (
  ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  NAME VARCHAR2(100) NOT NULL UNIQUE
);

-- Seed Data for References
INSERT INTO DOC_REFS (NAME) VALUES ('Passport');
INSERT INTO DOC_REFS (NAME) VALUES ('National ID');
INSERT INTO DOC_REFS (NAME) VALUES ('Birth Certificate');
INSERT INTO DOC_REFS (NAME) VALUES ('Driving License');
COMMIT;

-- 1. Patient Info Table (Formerly DOC_MASTERS)
CREATE TABLE PATIENT_INFO (
  PATIENT_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  FRONTEND_UUID VARCHAR2(64) NOT NULL UNIQUE, -- UUID from frontend for idempotency
  PATIENT_NAME VARCHAR2(255),
  GENDER VARCHAR2(20),     -- [NEW]
  DOB DATE,
  AGE VARCHAR2(20),        -- [NEW] Use Varchar to store "25y" or "6M"
  CONTACT_NO VARCHAR2(50), -- Renamed from PHONE
  ADDRESS VARCHAR2(500),   -- [NEW]
  REF_ID NUMBER,
  CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_doc_ref FOREIGN KEY (REF_ID) REFERENCES DOC_REFS(ID)
);

-- 2. Patient Doc Info Table (Formerly DOC_IMAGES)
CREATE TABLE PATIENT_DOC_INFO (
  FILE_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  PATIENT_ID NUMBER NOT NULL,
  SEQUENCE_NO NUMBER DEFAULT 0,
  PHOTO_MIME_TYPE VARCHAR2(100), -- Renamed from MIME_TYPE
  patient_doc BLOB,              -- Renamed from IMAGE_DATA
  CONSTRAINT fk_patient_info
    FOREIGN KEY (PATIENT_ID)
    REFERENCES PATIENT_INFO(PATIENT_ID)
    ON DELETE CASCADE
);

-- Comments for documentation
COMMENT ON TABLE PATIENT_INFO IS 'Stores metadata for digitized patient documents';
COMMENT ON COLUMN PATIENT_INFO.FRONTEND_UUID IS 'Unique ID from frontend to prevent duplicate uploads';
COMMENT ON TABLE PATIENT_DOC_INFO IS 'Stores the actual image data (BLOB) linked to the patient record';

