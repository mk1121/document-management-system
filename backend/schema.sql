-- Oracle Database Schema for DocuDigitize Pro
-- REFACTORED: IDs are NUMBER (generated by identity or sequence).
-- Added missing columns (PO, PS, DIST, EMG_..., etc.)
-- AGE is NUMBER.

-- Clean Slate (Drop existing objects)
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE PATIENT_DOC_INFO CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP TABLE PATIENT_INFO CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP TABLE DOCTOR_INFO CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_FILE_ID';
  EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_PATIENT_ID'; -- If exists
  EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_DR_ID';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 AND SQLCODE != -2289 THEN RAISE; END IF;
END;
/

-- 1. DOCTOR_INFO Table (Numeric ID)
CREATE TABLE DOCTOR_INFO (
  DR_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  DR_NAME VARCHAR2(200),
  ADDRESS VARCHAR2(200),
  REG_NO VARCHAR2(50),
  CONTACT_NO NUMBER,
  EMAIL VARCHAR2(30),
  REMARKS VARCHAR2(200)
);

-- Seed Data
INSERT INTO DOCTOR_INFO (DR_NAME, REG_NO) VALUES ('Dr. A. Rahman', 'REG-001');
INSERT INTO DOCTOR_INFO (DR_NAME, REG_NO) VALUES ('Dr. B. Karim', 'REG-002');
INSERT INTO DOCTOR_INFO (DR_NAME, REG_NO) VALUES ('Dr. C. Chowdhury', 'REG-003');
COMMIT;

-- 2. PATIENT_INFO Table (Matching User DDL + Standardizing)
CREATE TABLE PATIENT_INFO (
    PATIENT_ID NUMBER GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER NOCYCLE NOKEEP NOSCALE NOT NULL ENABLE, 
    PATIENT_NAME VARCHAR2(300 BYTE) NOT NULL ENABLE, 
    GENDER VARCHAR2(10 BYTE), 
    DOB DATE, 
    AGE NUMBER, -- Changed to NUMBER
    APP_DATE DATE, 
    ADDRESS VARCHAR2(300 BYTE), 
    PO VARCHAR2(50 BYTE), 
    PS VARCHAR2(50 BYTE), 
    DIST VARCHAR2(50 BYTE), 
    CONTACT_NO VARCHAR2(30 BYTE) NOT NULL ENABLE, 
    EMG_CONTACT_PERSON VARCHAR2(300 BYTE), 
    EMG_CONTACT_NO VARCHAR2(30 BYTE), 
    USER_ID VARCHAR2(30 BYTE), 
    ENTER_DATE DATE DEFAULT SYSDATE, 
    LAST_UPDATE VARCHAR2(30 BYTE), 
    LAST_UPDATE_DATE DATE, 
    REF_BY VARCHAR2(200 BYTE), 
    DOCTOR_NAME VARCHAR2(200 BYTE), 
    FRONTEND_UUID VARCHAR2(64 BYTE), -- For idempotency
    CREATED_AT TIMESTAMP (6) DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT PATIENT_INFO_CON PRIMARY KEY (PATIENT_ID),
    CONSTRAINT PATIENT_INFO_UUID_UNQ UNIQUE (FRONTEND_UUID)
);

-- 3. PATIENT_DOC_INFO Table
CREATE TABLE PATIENT_DOC_INFO (
    PATIENT_ID NUMBER, 
    FILE_ID NUMBER, 
    PATIENT_DOC BLOB, 
    USER_ID VARCHAR2(30 BYTE), 
    ENTER_DATE DATE DEFAULT SYSDATE, 
    LAST_UPDATE VARCHAR2(30 BYTE), 
    LAST_UPDATE_DATE DATE, 
    FILE_NAME VARCHAR2(200 BYTE), 
    PHOTO_MIME_TYPE VARCHAR2(200 BYTE), 
    PHOTO_CHARSET VARCHAR2(200 BYTE), 
    SEQUENCE_NO NUMBER DEFAULT 0,
    CONSTRAINT PATIENT_DOC_INFO_CON PRIMARY KEY (PATIENT_ID, FILE_ID),
    CONSTRAINT PATIENT_DOC_INFO_FKCON FOREIGN KEY (PATIENT_ID) REFERENCES PATIENT_INFO (PATIENT_ID)
);

-- Sequence and Trigger for FILE_ID (as per user request)
CREATE SEQUENCE SEQ_FILE_ID START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER TRG_FILE_ID 
BEFORE INSERT ON PATIENT_DOC_INFO
FOR EACH ROW
BEGIN
  IF :NEW.FILE_ID IS NULL THEN
    :NEW.FILE_ID := SEQ_FILE_ID.NEXTVAL;
  END IF;
END;
/
