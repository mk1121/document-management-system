-- Oracle Database Schema for DocuDigitize Pro

-- Drop tables if they exist (to allow clean re-runs)
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE DOC_IMAGES';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE DOC_MASTERS';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

-- 1a. References Table (New)
CREATE TABLE DOC_REFS (
  ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  NAME VARCHAR2(100) NOT NULL UNIQUE
);

-- Seed Data for References
INSERT INTO DOC_REFS (NAME) VALUES ('Passport');
INSERT INTO DOC_REFS (NAME) VALUES ('National ID');
INSERT INTO DOC_REFS (NAME) VALUES ('Birth Certificate');
INSERT INTO DOC_REFS (NAME) VALUES ('Driving License');
COMMIT;

-- 1. Documents Master Table
CREATE TABLE DOC_MASTERS (
  ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  FRONTEND_UUID VARCHAR2(64) NOT NULL UNIQUE, -- UUID from frontend for idempotency
  FULL_NAME VARCHAR2(255),
  DOB DATE,
  PHONE VARCHAR2(50),
  REF_ID NUMBER, -- Linked Reference
  CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_doc_ref FOREIGN KEY (REF_ID) REFERENCES DOC_REFS(ID)
);

-- 2. Document Images Table (BLOB storage)
CREATE TABLE DOC_IMAGES (
  ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  MASTER_ID NUMBER NOT NULL,
  SEQUENCE_NO NUMBER DEFAULT 0,
  MIME_TYPE VARCHAR2(100),
  IMAGE_DATA BLOB,
  CONSTRAINT fk_doc_master
    FOREIGN KEY (MASTER_ID)
    REFERENCES DOC_MASTERS(ID)
    ON DELETE CASCADE
);

-- Comments for documentation
COMMENT ON TABLE DOC_MASTERS IS 'Stores metadata for digitized documents';
COMMENT ON COLUMN DOC_MASTERS.FRONTEND_UUID IS 'Unique ID from frontend to prevent duplicate uploads';
COMMENT ON COLUMN DOC_MASTERS.REF_ID IS 'Foreign key to DOC_REFS table';
COMMENT ON TABLE DOC_IMAGES IS 'Stores the actual image data (BLOB) linked to the master record';
