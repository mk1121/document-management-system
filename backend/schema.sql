-- Oracle Database Schema for DocuDigitize Pro
-- REFACTORED: IDs are NUMBER (generated by identity or sequence).
-- Added missing columns (PO, PS, DIST, EMG_..., etc.)
-- AGE is NUMBER.

-- Clean Slate (Drop existing objects)
-- Clean Slate (Drop existing objects)
BEGIN
  BEGIN EXECUTE IMMEDIATE 'DROP TABLE PATIENT_DOC_INFO CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
  BEGIN EXECUTE IMMEDIATE 'DROP TABLE PATIENT_INFO CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
  BEGIN EXECUTE IMMEDIATE 'DROP TABLE FD_PATIENT_SEQ CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
  -- Preserving DOCTOR_INFO
  -- BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_DR_ID'; EXCEPTION WHEN OTHERS THEN NULL; END; 
  BEGIN EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_FILE_ID'; EXCEPTION WHEN OTHERS THEN NULL; END;
END;
/

-- 1. DOCTOR_INFO (Preserved - Creation commented out or use IF NOT EXISTS logic if needed)
-- Assuming DOCTOR_INFO exists. If running fresh, uncomment:
/*
CREATE TABLE DOCTOR_INFO (
  DR_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  DR_NAME VARCHAR2(200),
  ADDRESS VARCHAR2(200),
  REG_NO VARCHAR2(50),
  CONTACT_NO NUMBER,
  EMAIL VARCHAR2(30),
  REMARKS VARCHAR2(200)
);
*/

-- 2. FD_PATIENT_SEQ (New Table for Custom Sequence)
CREATE TABLE FD_PATIENT_SEQ (
    BRANCH_CODE VARCHAR2(15),
    YEAR_NO NUMBER,
    LAST_NO NUMBER,
    CONSTRAINT FD_PATIENT_SEQ_PK PRIMARY KEY (BRANCH_CODE, YEAR_NO)
);

-- 3. PATIENT_INFO Table (Refactored)
CREATE TABLE PATIENT_INFO (
    PATIENT_ID VARCHAR2(30) NOT NULL, -- CHANGED to VARCHAR2
    BRANCH_NAME VARCHAR2(15),         -- NEW: FD1, FD2, etc.
    PATIENT_TYPE VARCHAR2(30),        -- NEW: General, Orth, Surgery
    PATIENT_NAME VARCHAR2(300 BYTE) NOT NULL ENABLE, 
    GENDER VARCHAR2(10 BYTE), 
    DOB DATE, 
    AGE NUMBER,
    APP_DATE DATE,                    -- NEW
    ADDRESS VARCHAR2(300 BYTE), 
    PO VARCHAR2(50 BYTE),             -- NEW
    PS VARCHAR2(50 BYTE),             -- NEW
    DIST VARCHAR2(50 BYTE),           -- NEW
    CONTACT_NO VARCHAR2(30 BYTE) NOT NULL ENABLE, 
    EMG_CONTACT_PERSON VARCHAR2(300 BYTE), -- NEW
    EMG_CONTACT_NO VARCHAR2(30 BYTE),      -- NEW
    USER_ID VARCHAR2(30 BYTE), 
    ENTER_DATE DATE DEFAULT SYSDATE, 
    LAST_UPDATE VARCHAR2(30 BYTE), 
    LAST_UPDATE_DATE DATE, 
    REF_BY VARCHAR2(200 BYTE),        -- NEW
    DOCTOR_NAME VARCHAR2(200 BYTE), 
    FRONTEND_UUID VARCHAR2(64 BYTE),
    CREATED_AT TIMESTAMP (6) DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT PATIENT_INFO_CON PRIMARY KEY (PATIENT_ID),
    CONSTRAINT PATIENT_INFO_UUID_UNQ UNIQUE (FRONTEND_UUID)
);

-- 4. PATIENT_DOC_INFO Table
CREATE TABLE PATIENT_DOC_INFO (
    PATIENT_ID VARCHAR2(30), -- CHANGED to VARCHAR2
    FILE_ID NUMBER, 
    PATIENT_DOC BLOB, 
    USER_ID VARCHAR2(30 BYTE), 
    ENTER_DATE DATE DEFAULT SYSDATE, 
    LAST_UPDATE VARCHAR2(30 BYTE), 
    LAST_UPDATE_DATE DATE, 
    FILE_NAME VARCHAR2(200 BYTE), 
    PHOTO_MIME_TYPE VARCHAR2(200 BYTE), 
    PHOTO_CHARSET VARCHAR2(200 BYTE), 
    SEQUENCE_NO NUMBER DEFAULT 0,
    NEXT_APP DATE, -- [NEW]
    CONSTRAINT PATIENT_DOC_INFO_CON PRIMARY KEY (PATIENT_ID, FILE_ID),
    CONSTRAINT PATIENT_DOC_INFO_FKCON FOREIGN KEY (PATIENT_ID) REFERENCES PATIENT_INFO (PATIENT_ID)
);

-- Sequence and Trigger for FILE_ID
CREATE SEQUENCE SEQ_FILE_ID START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER TRG_FILE_ID 
BEFORE INSERT ON PATIENT_DOC_INFO
FOR EACH ROW
BEGIN
  IF :NEW.FILE_ID IS NULL THEN
    :NEW.FILE_ID := SEQ_FILE_ID.NEXTVAL;
  END IF;
END;
/

-- 5. Trigger for PATIENT_ID Generation
CREATE OR REPLACE TRIGGER "TRG_PATIENT_ID" 
BEFORE INSERT ON PATIENT_INFO
FOR EACH ROW
DECLARE
    v_year     NUMBER := EXTRACT(YEAR FROM SYSDATE);
    v_next_no  NUMBER;
BEGIN
    IF :NEW.PATIENT_ID IS NULL THEN

        -- Try to update existing counter
        UPDATE FD_PATIENT_SEQ
           SET LAST_NO = LAST_NO + 1
         WHERE BRANCH_CODE = :NEW.BRANCH_NAME
           AND YEAR_NO     = v_year
         RETURNING LAST_NO INTO v_next_no;

        -- If no row updated, insert new counter
        IF SQL%ROWCOUNT = 0 THEN
            INSERT INTO FD_PATIENT_SEQ
                (BRANCH_CODE, YEAR_NO, LAST_NO)
            VALUES
                (:NEW.BRANCH_NAME, v_year, 1);

            v_next_no := 1;
        END IF;

        -- Generate patient_id
        :NEW.PATIENT_ID :=
              :NEW.BRANCH_NAME || '-' ||
              v_year || '-' ||
              LPAD(v_next_no, 4, '0');
    END IF;
END;
/
